<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="IE=edge">
<title>Web Latency Benchmark</title>
<link rel="stylesheet" href="latency-benchmark.css">

<h1>Web Latency Test: End-To-End</h1>
This test requires specialized hardware: an <a href="https://www.oculusvr.com/order/latency-tester/">Oculus Latency Tester</a> device. Point it at the square below and press 'T' to start the test.
<p>
<canvas id="testCanvas" width="300" height="300" style="border: 10px solid gray"></canvas>

<p>
<label><input type="checkbox" id="cpuLoad"/> add CPU load</label><br/>

<div id="results">

<script src="keep-server-alive.js"></script>
<script>
var cpuLoad = document.getElementById('cpuLoad');
var testCanvas = document.getElementById('testCanvas');
var gl = testCanvas.getContext('webgl') || testCanvas.getContext('experimental-webgl');
var color = [0, 0, 0];

window.onkeydown = function(e) {
  if (e.keyCode == 66) {
    // 'B' for black.
    color = [0, 0, 0];
  }
  if (e.keyCode == 87) {
    // 'W' for white.
    color = [1, 1, 1];
  }
  if (e.keyCode == 84) {
    // 'T' for test.
    startTest();
  }
};

function draw() {
  requestAnimationFrame(draw);
  gl.clearColor(color[0], color[1], color[2], 1);
  gl.clear(gl.COLOR_BUFFER_BIT);
  if (cpuLoad.checked) {
    var startTime = Date.now();
    while(Date.now() - startTime < 14);
  }
}
draw();

function startTest() {
  var request = new XMLHttpRequest();
  request.open('GET', 'http://localhost:5578/oculusLatencyTester', true);
  request.onreadystatechange = function() {
    if (request.readyState == 4) {
      if (request.status == 200) {
        alert(request.response);
      } else if (request.status == 500) {
        alert(request.response);
      } else {
        alert('unknown');
      }
    }
  };
  request.send();
}
</script>
